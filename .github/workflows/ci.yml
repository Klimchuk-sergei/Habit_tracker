name: CI/CD

on:
  push:
    branches: [ feature_final, main, develop ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    env:
      SECRET_KEY: ${{ secrets.SECRET_KEY }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Lint with flake8
        run: flake8 .

      - name: Run tests
        run: python manage.py test

      - name: Create .env from .env.example for Docker build
        run: |
          cp .env.example .env
          # –ó–∞–º–µ–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã–µ
          sed -i 's/your-secret-key/test-secret-key-for-ci/g' .env
          sed -i 's/DEBUG=True/DEBUG=False/g' .env
          sed -i 's/DB_HOST=localhost/DB_HOST=db/g' .env
          sed -i 's/CELERY_BROKER_URL=redis:\/\/localhost:6379\/0/CELERY_BROKER_URL=redis:\/\/redis:6379\/0/g' .env
          sed -i 's/CELERY_RESULT_BACKEND=redis:\/\/localhost:6379\/0/CELERY_RESULT_BACKEND=redis:\/\/redis:6379\/0/g' .env
          sed -i 's/your-telegram-bot-token/test-telegram-token/g' .env

      - name: Build Docker images
        run: docker compose build

      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /home/ubuntu/habittracker
            git pull origin main
            docker compose down
            docker compose up -d --build
            echo "üöÄ Deployment completed successfully!"
