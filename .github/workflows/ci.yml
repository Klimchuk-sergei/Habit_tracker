name: Django CI/CD Pipeline

on:
  push:
    branches: [ feature_final, main, develop ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run Flake8
        run: flake8 .

  test:
    runs-on: ubuntu-latest
    needs: lint

    env:
      SECRET_KEY: ${{ secrets.SECRET_KEY }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run tests
        run: python manage.py test

  build:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env from .env.example for Docker build
        run: |
          cp .env.example .env
          sed -i 's/your-secret-key/test-secret-key-for-ci/g' .env
          sed -i 's/DEBUG=True/DEBUG=False/g' .env
          sed -i 's/DB_HOST=localhost/DB_HOST=db/g' .env
          sed -i 's/CELERY_BROKER_URL=redis:\/\/localhost:6379\/0/CELERY_BROKER_URL=redis:\/\/redis:6379\/0/g' .env
          sed -i 's/CELERY_RESULT_BACKEND=redis:\/\/localhost:6379\/0/CELERY_RESULT_BACKEND=redis:\/\/redis:6379\/0/g' .env
          sed -i 's/your-telegram-bot-token/test-telegram-token/g' .env

      - name: Build Docker images
        run: docker compose build

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /home/ubuntu/habittracker
            git pull origin main
            docker compose down
            docker compose up -d --build
            echo "ðŸš€ Deployment completed successfully!"